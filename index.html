<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Steam Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js" defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .chart-container { background-color: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
        .recharts-tooltip-wrapper { background-color: #333 !important; border: 1px solid #555 !important; color: #fff !important; padding: 8px !important; border-radius: 4px !important; box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important; }
        .recharts-tooltip-item { color: #fff !important; font-size: 0.75rem; }
        .recharts-tooltip-label { color: #ccc !important; margin-bottom: 4px !important; font-weight: bold !important; }
        .recharts-text { fill: #8b949e; }
        .recharts-cartesian-axis-tick-value { font-size: 0.75rem; }
        h1, h2 { color: #f0f6fc; }
        select, button { background-color: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; padding: 8px 12px; margin-right: 8px; font-size: 0.875rem; }
        button:hover { background-color: #30363d; }
        button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #21262d; }
        /* Specific styles for App layout */
        main { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; /* 12-column grid */ }
        .report-span-6 { grid-column: span 12 / span 12; /* Full width on small screens */ }
        .report-span-4 { grid-column: span 12 / span 12; }
        .report-span-8 { grid-column: span 12 / span 12; }
        @media (min-width: 1024px) { /* Adjust column spans for larger screens */
            .report-span-6 { grid-column: span 6 / span 6; }
            .report-span-4 { grid-column: span 4 / span 4; }
            .report-span-8 { grid-column: span 8 / span 8; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        console.log("Starting React script...");

        // Check libraries
        if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined' || typeof window.Recharts === 'undefined') {
            const missing = [
                !window.React && "React",
                !window.ReactDOM && "ReactDOM",
                !window.Recharts && "Recharts"
            ].filter(Boolean).join(", ");
            console.error(`${missing} library failed to load!`);
            document.getElementById('root').innerHTML = `<h1 style="color:red;">Error: ${missing} failed to load. Check console.</h1>`;
            throw new Error(`${missing} not loaded`);
        }
        console.log("React, ReactDOM, Recharts confirmed loaded.");

        const { useState, useEffect, useCallback } = React;
        const { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, ScatterChart, Scatter, XAxis, YAxis, ZAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Label } = window.Recharts; // Removed Text import as unused

        // --- Custom Tooltip ---
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="recharts-tooltip-wrapper">
                        <p className="recharts-tooltip-label">{`${label}`}</p>
                        {payload.map((pld, index) => (
                            <p key={index} style={{ color: pld.color }} className="recharts-tooltip-item">
                                {`${pld.name}: ${typeof pld.value === 'number' ? pld.value.toLocaleString() : pld.value}`}
                            </p>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // --- Report Components ---

        // Report 1: Most Played Games (Table with Enhanced Bar) - Reverted
        function MostPlayedTable() {
            const [data, setData] = useState([]);
            const [year, setYear] = useState('');
            const [years, setYears] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [maxPeakCCU, setMaxPeakCCU] = useState(1); // State to hold the max peak for percentage calculation

            // Fetch available years
            useEffect(() => {
                fetch("http://localhost:5000/api/years")
                    .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                    .then(data => setYears(data.map(item => item.ReleaseYear).sort((a,b) => b-a)))
                    .catch(error => { console.error('Error fetching years:', error); /* Don't set main error */ });
            }, []);

            // Fetch data (using the endpoint that includes AvgPlaytimeForever for potential future use, though not displayed)
            useEffect(() => {
                const url = year ? `http://localhost:5000/api/most-played?year=${year}` : "http://localhost:5000/api/most-played";
                setLoading(true); setError(null);
                console.log(`MostPlayedTable: Fetching from ${url}`);
                fetch(url)
                    .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                    .then(rawData => {
                        console.log("MostPlayedTable: Raw data received", rawData ? rawData.length : 0);
                        const filteredData = (rawData || [])
                            .filter(item => item && item.AppName && item.Peak_CCU != null && item.Peak_CCU > 0)
                            .sort((a, b) => b.Peak_CCU - a.Peak_CCU) // Ensure sorting
                            .slice(0, 10); // Ensure only top 10

                        // Find the maximum peak CCU for the progress bar
                        const maxPeak = filteredData.length > 0 ? Math.max(...filteredData.map(item => item.Peak_CCU)) : 1;
                        setMaxPeakCCU(maxPeak > 0 ? maxPeak : 1); // Avoid division by zero

                        setData(filteredData);
                        setLoading(false);
                    })
                    .catch(error => {
                        console.error('Error fetching most played table data:', error);
                        setError(`Failed to load data: ${error.message}`); setData([]); setMaxPeakCCU(1); setLoading(false);
                    });
            }, [year]);

             // Helper function for formatting numbers
             const formatNumber = (num) => {
                 if (num === null || num === undefined) return 'N/A';
                 if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
                 if (num >= 1000) return `${(num / 1000).toFixed(0)}K`;
                 return num.toLocaleString();
            }; // Make sure this helper function is defined if it wasn't already global

            return (
                // Use grid span class for layout
                <div className="chart-container report-span-6">
                    {/* Header section with title and year selector */}
                    <div className="flex flex-wrap justify-between items-center mb-4 gap-2">
                         <h2 className="text-xl font-bold text-white">Highest Peak Concurrent Users {year && `(${year})`}</h2>
                         <div>
                             <label htmlFor="year-select-mostplayed" className="mr-2 text-sm text-gray-400">Slice by Year:</label>
                             <select id="year-select-mostplayed" value={year} onChange={(e) => setYear(e.target.value)} className="bg-gray-700 border border-gray-600 text-white text-sm rounded focus:ring-blue-500 focus:border-blue-500">
                                 <option value="">All Years</option>
                                 {years.map(y => <option key={y} value={y}>{y}</option>)}
                             </select>
                         </div>
                    </div>

                     {/* Loading/Error/No Data messages */}
                     {loading && <p className="text-center text-gray-400 py-4">Loading...</p>}
                     {error && <p className="text-center text-red-500 py-4">Error: {error}</p>}
                     {!loading && !error && data.length === 0 && <p className="text-center text-gray-500 py-4">No data available.</p>}

                     {/* Table rendering */}
                     {!loading && !error && data.length > 0 && (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-gray-400">
                                <thead className="text-xs text-gray-400 uppercase bg-gray-700/50">
                                    <tr>
                                        <th scope="col" className="px-3 py-2 text-center w-10">#</th>
                                        <th scope="col" className="px-3 py-2">Game</th>
                                        <th scope="col" className="px-3 py-2 text-left">Peak Players (Historical)</th> {/* Left aligned header */}
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map((item, index) => {
                                        // Calculate bar width percentage
                                        const barWidthPercent = maxPeakCCU > 0 ? (item.Peak_CCU / maxPeakCCU) * 100 : 0;
                                        return (
                                            <tr key={item.AppName || index} className="border-b bg-gray-800 border-gray-700 hover:bg-gray-700/50 align-middle">
                                                <td className="px-3 py-2 text-center">{index + 1}</td>
                                                <th scope="row" className="px-3 py-2 font-medium whitespace-nowrap text-white">
                                                    {item.AppName}
                                                </th>
                                                {/* Peak Players with ENHANCED Progress Bar */}
                                                <td className="px-3 py-3"> {/* Use py-3 */}
                                                    <div className="flex items-center gap-3">
                                                        {/* Number (comes first) */}
                                                        <span className="font-semibold text-white w-20 text-right">{item.Peak_CCU.toLocaleString()}</span>
                                                        {/* Progress Bar Container (takes remaining space) */}
                                                        <div className="flex-grow h-4 bg-gray-600 rounded overflow-hidden">
                                                            {/* Progress Bar Fill */}
                                                            <div
                                                                className="h-full bg-blue-500 rounded"
                                                                style={{ width: `${barWidthPercent}%` }}
                                                                title={`${barWidthPercent.toFixed(1)}% of Max Peak (${maxPeakCCU.toLocaleString()})`}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                     )}
                </div>
            );
        }

        // Report 2: Game Releases Over Time (Line Chart - Replaces "Trending")
        function ReleaseTrendsChart() { // Renamed from TrendingPanel
            const [data, setData] = useState([]);
            const [granularity, setGranularity] = useState('year');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const fetchData = useCallback(() => { /* Fetch logic unchanged */
                const url = `http://localhost:5000/api/release-trends?granularity=${granularity}`;
                setLoading(true); setError(null);
                fetch(url)
                     .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                    .then(rawData => {
                        const sortedData = (rawData || []).sort((a, b) => granularity === 'year' ? (a.year || 0) - (b.year || 0) : (a.date || '').localeCompare(b.date || ''));
                        setData(sortedData); setLoading(false);
                    })
                    .catch(error => { console.error('Error R2:', error); setError(error.message); setData([]); setLoading(false); });
            }, [granularity]);

            useEffect(() => { fetchData(); }, [fetchData]);

            const handleRollUp = () => { if (granularity === 'day') setGranularity('month'); else if (granularity === 'month') setGranularity('year'); };
            const handleDrillDown = () => { if (granularity === 'year') setGranularity('month'); else if (granularity === 'month') setGranularity('day'); };
            const dateKey = granularity === 'year' ? 'year' : 'date';
            const formatXAxis = (tickItem) => { /* Unchanged */
                 if (!tickItem) return ''; try { if (granularity === 'month' && tickItem.includes('-')) { const [y, m] = tickItem.split('-'); return new Date(parseInt(y), parseInt(m) - 1).toLocaleDateString(undefined, { year: 'numeric', month: 'short' }); } if (granularity === 'day' && tickItem.includes('-')) { const d = new Date(tickItem); const adj = new Date(d.getTime() + d.getTimezoneOffset() * 60000); return adj.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); } } catch(e) { console.error("Err format date:", tickItem, e); } return tickItem;
            };

            return (
                // Use grid span class for layout
                <div className="chart-container report-span-6">
                     {/* Header section with title and buttons (unchanged) */}
                     <div className="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 className="text-xl font-bold">Game Releases Over Time ({granularity})</h2>
                        <div>
                             <button onClick={handleRollUp} disabled={granularity === 'year'}> Roll Up ▲ </button>
                             <button onClick={handleDrillDown} disabled={granularity === 'day'}> Drill Down ▼ </button>
                        </div>
                    </div>
                    {/* Loading/Error/No Data messages (unchanged) */}
                    {loading && <p className="text-center text-gray-400 py-4">Loading...</p>}
                    {error && <p className="text-center text-red-500 py-4">Error: {error}</p>}
                    {!loading && !error && data.length === 0 && <p className="text-center text-gray-500 py-4">No data.</p>}

                    {/* Chart rendering */}
                    {!loading && !error && data.length > 0 && (
                        <ResponsiveContainer width="100%" height={450}> {/* Increased height back to 350 */}
                            <LineChart data={data} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                                 <CartesianGrid strokeDasharray="3 3" stroke="#30363d" />
                                 {/* Keep XAxis height for angled labels */}
                                 <XAxis dataKey={dateKey} stroke="#8b949e" tick={{ fontSize: 10 }} tickFormatter={formatXAxis} angle={-30} textAnchor="end" interval="preserveStartEnd" height={50} dy={10} />
                                 <YAxis stroke="#8b949e" label={{ value: 'Games Released', angle: -90, position: 'insideLeft', fill: '#8b949e' }} />
                                <Tooltip content={<CustomTooltip />} />
                                <Legend verticalAlign="top" height={36}/>
                                 <Line type="monotone" dataKey="count" name="# Games Released" stroke="#82ca9d" dot={false} activeDot={{ r: 6 }} />
                            </LineChart>
                        </ResponsiveContainer>
                    )}
                </div>
            );
        }

        // Report 3: Top Rated Games (Scatter Plot)
         function TopRatedScatterPlot() {
             const [data, setData] = useState([]);
             const [loading, setLoading] = useState(false);
             const [error, setError] = useState(null);

             useEffect(() => { /* Fetch data */
                 setLoading(true); setError(null);
                 fetch(`http://localhost:5000/api/top-rated`)
                     .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                     .then(rawData => {
                         const filteredData = (rawData || []).filter(d => d && d.Metacritic_Score != null && d.Metacritic_Score > 0 && d.User_Score != null && d.User_Score > 0 );
                         setData(filteredData); setLoading(false);
                     })
                     .catch(error => { console.error(`Error R3:`, error); setError(error.message); setData([]); setLoading(false); });
             }, []);

             return (
                 <div className="chart-container report-span-8"> {/* Use grid span class */}
                     <h2 className="text-xl font-bold mb-4">Top Rated Games (Metacritic vs. User Score)</h2>
                     {loading && <p className="text-center text-gray-400 py-4">Loading...</p>}
                     {error && <p className="text-center text-red-500 py-4">Error: {error}</p>}
                     {!loading && !error && data.length === 0 && <p className="text-center text-gray-500 py-4">No data.</p>}
                     {!loading && !error && data.length > 0 && (
                         <ResponsiveContainer width="100%" height={300}>
                              <ScatterChart margin={{ top: 20, right: 30, bottom: 20, left: 20 }}>
                                 <CartesianGrid strokeDasharray="3 3" stroke="#30363d" />
                                 <XAxis type="number" dataKey="Metacritic_Score" name="Metacritic Score" stroke="#8b949e" domain={[0, 100]} label={{ value: 'Metacritic Score', position: 'insideBottom', offset: -10, fill: '#8b949e' }} />
                                  <YAxis type="number" dataKey="User_Score" name="User Score" stroke="#8b949e" domain={[0, 10]} label={{ value: 'User Score', angle: -90, position: 'insideLeft', fill: '#8b949e' }} />
                                 <Tooltip cursor={{ strokeDasharray: '3 3' }} content={<CustomTooltip />} />
                                 <Scatter name="Games" data={data} fill="#8884d8" />
                             </ScatterChart>
                         </ResponsiveContainer>
                     )}
                 </div>
             );
         }

        // Report 4: Price vs Rating (Bubble Chart)
        function PriceVsRatingBubbleChart() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => { /* Fetch data */
                setLoading(true); setError(null);
                fetch(`http://localhost:5000/api/price-vs-rating`)
                    .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                    .then(rawData => {
                        const filteredData = (rawData || []).filter(d => d && d.Launch_Price != null && d.Launch_Price >= 0 && d.User_Score != null && d.User_Score > 0 && d.TotalReviews != null && d.TotalReviews > 0);
                        setData(filteredData); setLoading(false);
                    })
                    .catch(error => { console.error(`Error R4:`, error); setError(error.message); setData([]); setLoading(false); });
            }, []);

            return (
                <div className="chart-container report-span-8"> {/* Use grid span class */}
                    <h2 className="text-xl font-bold mb-4">Price vs. User Score (Bubble Size = Reviews)</h2>
                    {loading && <p className="text-center text-gray-400 py-4">Loading...</p>}
                    {error && <p className="text-center text-red-500 py-4">Error: {error}</p>}
                    {!loading && !error && data.length === 0 && <p className="text-center text-gray-500 py-4">No data.</p>}
                    {!loading && !error && data.length > 0 && (
                        <ResponsiveContainer width="100%" height={300}>
                             <ScatterChart margin={{ top: 20, right: 30, bottom: 20, left: 20 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#30363d" />
                                 <XAxis type="number" dataKey="Launch_Price" name="Price ($)" stroke="#8b949e" label={{ value: 'Launch Price ($)', position: 'insideBottom', offset: -10, fill: '#8b949e' }} tickFormatter={(v) => `$${v.toFixed(0)}`} />
                                 <YAxis type="number" dataKey="User_Score" name="User Score" stroke="#8b949e" domain={[0, 10]} label={{ value: 'User Score', angle: -90, position: 'insideLeft', fill: '#8b949e' }} />
                                 <ZAxis type="number" dataKey="TotalReviews" name="Total Reviews" range={[20, 800]} />{/* Adjusted range */}
                                <Tooltip cursor={{ strokeDasharray: '3 3' }} content={<CustomTooltip />} />
                                 <Scatter name="Games" data={data} fill="#82ca9d" />
                            </ScatterChart>
                        </ResponsiveContainer>
                     )}
                </div>
            );
        }

        // Report 5: Platform Availability Breakdown (Pie Chart)
        function PlatformPieChart() { // Renamed from PlatformBreakdown
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const COLORS = ['#0088FE', '#00C49F', '#FFBB28']; // Win, Mac, Linux

            useEffect(() => { /* Fetch data */
                setLoading(true); setError(null);
                fetch("http://localhost:5000/api/platforms-breakdown")
                    .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                    .then(rawData => {
                        const formattedData = (rawData || [])
                                            .filter(item => item && item.platform && item.count > 0)
                                            .map(item => ({ name: item.platform, value: item.count }));
                        setData(formattedData); setLoading(false);
                    })
                    .catch(error => { console.error('Error R5:', error); setError(error.message); setData([]); setLoading(false); });
            }, []);

            const RADIAN = Math.PI / 180;
            const renderCustomizedLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent, name }) => { /* Unchanged */
                const radius = innerRadius + (outerRadius - innerRadius) * 0.5; const x = cx + radius * Math.cos(-midAngle * RADIAN); const y = cy + radius * Math.sin(-midAngle * RADIAN); if (percent < 0.03) return null; return ( <text x={x} y={y} fill="white" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" fontSize={10}> {`${name} ${(percent * 100).toFixed(0)}%`} </text> );
            };

            return (
                <div className="chart-container report-span-4"> {/* Use grid span class */}
                    <h2 className="text-xl font-bold mb-4">Platform Distribution</h2>
                    {loading && <p className="text-center text-gray-400 py-4">Loading...</p>}
                    {error && <p className="text-center text-red-500 py-4">Error: {error}</p>}
                    {!loading && !error && data.length === 0 && <p className="text-center text-gray-500 py-4">No data.</p>}
                    {!loading && !error && data.length > 0 && (
                        <ResponsiveContainer width="100%" height={300}> {/* Matched height */}
                            <PieChart>
                                <Pie data={data} cx="50%" cy="50%" labelLine={false} label={renderCustomizedLabel} outerRadius={80} fill="#8884d8" dataKey="value" nameKey="name">
                                    {data.map((entry, index) => ( <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} /> ))}
                                </Pie>
                                <Tooltip content={<CustomTooltip />}/>
                                <Legend verticalAlign="bottom" height={36}/>
                            </PieChart>
                        </ResponsiveContainer>
                    )}
                </div>
            );
        }


        // --- Main App Component ---
        function App() {
            const [backendStatus, setBackendStatus] = useState('Connecting...');
            useEffect(() => { /* Backend status check - unchanged */
                fetch('http://localhost:5000/api/')
                    .then(res => { if (res.ok) setBackendStatus('Connected'); else throw new Error(`Status: ${res.status}`); })
                    .catch((error) => setBackendStatus(`Connection Error`)); // Simplified error
            }, []);

            return (
                 <div className="min-h-screen p-4 sm:p-6 lg:p-8">
                     <header className="flex flex-wrap justify-between items-center mb-6 border-b border-gray-700 pb-4 gap-2">
                        <h1 className="text-2xl sm:text-3xl font-black tracking-tighter">Steam Analytics Dashboard 📊</h1>
                         <div className="flex items-center space-x-2">
                             <span className={`h-3 w-3 rounded-full flex-shrink-0 ${ backendStatus === 'Connected' ? 'bg-green-500 animate-pulse' : 'bg-red-500' }`}></span>
                             <span className="text-xs sm:text-sm text-gray-400">{backendStatus}</span>
                         </div>
                    </header>

                     {/* Main Grid Layout using Tailwind Grid */}
                     <main className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        {/* Row 1: Report 1 & 2 */}
                        <MostPlayedTable />       {/* Changed back to MostPlayedTable */}
                        <ReleaseTrendsChart />    {/* Kept this name from previous step */}

                        {/* Row 2: Report 5 & 3 */}
                        <PlatformPieChart />         {/* Spans 4 cols on lg */}
                        <TopRatedScatterPlot />      {/* Spans 8 cols on lg */}

                        {/* Row 3: Report 4 */}
                        <PriceVsRatingBubbleChart /> {/* Spans 8 cols on lg, implicitly centers slightly */}
                        {/* Empty spacer div to balance grid if needed, spans 4 cols */}
                        {/* <div className="report-span-4 hidden lg:block"></div> */}

                    </main>

                     <footer className="mt-8 text-center text-xs text-gray-500">
                        Analytics Dashboard | Data processed via STADVDB-MCO1
                    </footer>
                 </div>
            );
        }

        // --- Rendering logic ---
        try {
            const container = document.getElementById('root');
            if (!container) throw new Error("Root element '#root' not found!");
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
            console.log("React App render initiated.");
        } catch (e) {
            console.error("Error rendering React app:", e);
             const rootEl = document.getElementById('root');
             if(rootEl) rootEl.innerHTML = `<div style="color: red; padding: 20px;"><h1>App Error</h1><p>${e.message}. Check console.</p></div>`;
        }
    </script>
</body>
</html>