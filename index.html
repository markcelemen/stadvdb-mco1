<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DIMGAME Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Updated Library Imports -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .chart-container {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 24px;
        }
        .recharts-tooltip-wrapper {
            background-color: #161b22 !important;
            border: 1px solid #30363d !important;
            border-radius: 6px !important;
        }
        .recharts-text {
            fill: #8b949e;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, ScatterChart, Scatter, XAxis, YAxis, ZAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Label, Text } = Recharts;

        // Custom Tooltip for Charts
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="p-2 bg-[#0d1117] border border-gray-700 rounded-md shadow-lg">
                        <p className="label text-sm text-white">{`${label}`}</p>
                        {payload.map((pld, index) => (
                            <p key={index} style={{ color: pld.color }} className="text-xs">{`${pld.name}: ${pld.value.toLocaleString()}`}</p>
                        ))}
                    </div>
                );
            }
            return null;
        };
        
        // Report 1: Most Played Games (Bar Chart)
        function MostPlayed() {
            const [data, setData] = useState([]);

            useEffect(() => {
                fetch("http://localhost:5000/api/most-played")
                    .then(res => res.json())
                    .then(rawData => {
                        const filteredData = rawData.filter(item => item && item.Name && item.PeakCCU != null);
                        setData(filteredData);
                    })
                    .catch(error => console.error('Error fetching most played:', error));
            }, []);

            return (
                <div className="chart-container">
                    <h2 className="text-xl font-bold mb-4 text-white">Most Played Games by Peak Concurrent Users</h2>
                    <ResponsiveContainer width="100%" height={350}>
                        <BarChart data={data} layout="vertical" margin={{ top: 5, right: 30, left: 100, bottom: 5 }}>
                            <XAxis type="number" stroke="#8b949e" />
                            <YAxis type="category" dataKey="Name" stroke="#8b949e" width={150} tick={{ fontSize: 12 }} />
                            <Tooltip content={<CustomTooltip />} cursor={{ fill: 'rgba(136, 132, 216, 0.1)' }} />
                            <Bar dataKey="PeakCCU" name="Peak Users" fill="#8884d8" />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            );
        }

        // Report 2: Trending Games (Line Chart)
        function TrendingGames() {
            const [data, setData] = useState([]);

            useEffect(() => {
                fetch("http://localhost:5000/api/trending?limit=50")
                    .then(res => res.json())
                    .then(rawData => {
                         const filteredData = rawData
                            .filter(item => item && item.Name && item.ReleaseYear && item.ReleaseMonth && item.ReleaseDay)
                            .map(item => ({...item, date: `${item.ReleaseYear}-${String(item.ReleaseMonth).padStart(2, '0')}-${String(item.ReleaseDay).padStart(2, '0')}`}))
                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                            .slice(0, 15);
                        setData(filteredData.reverse()); // reverse for chronological line chart
                    })
                    .catch(error => console.error('Error fetching trending games:', error));
            }, []);

            return (
                <div className="chart-container">
                    <h2 className="text-xl font-bold mb-4 text-white">Top 15 Most Recent Releases</h2>
                     <ResponsiveContainer width="100%" height={350}>
                        <LineChart data={data} margin={{ top: 5, right: 30, left: 20, bottom: 80 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#30363d" />
                            <XAxis dataKey="Name" stroke="#8b949e" angle={-45} textAnchor="end" interval={0} tick={{ fontSize: 10 }} />
                            <YAxis stroke="#8b949e" />
                            <Tooltip content={<CustomTooltip />} />
                             <Line type="monotone" dataKey="ReleaseYear" name="Release Year" stroke="#8884d8" activeDot={{ r: 8 }} />
                        </LineChart>
                    </ResponsiveContainer>
                </div>
            );
        }
        
        // Report 3: Platform Breakdown (Pie Chart)
        function PlatformBreakdown() {
            const [data, setData] = useState([]);
            const COLORS = ['#0088FE', '#00C49F', '#FFBB28'];

            useEffect(() => {
                fetch("http://localhost:5000/api/platforms-breakdown")
                    .then(res => res.json())
                    .then(rawData => {
                        const filteredData = rawData.filter(item => item && item.name && item.value != null);
                        setData(filteredData);
                    })
                    .catch(error => console.error('Error fetching platforms:', error));
            }, []);

            return (
                <div className="chart-container">
                    <h2 className="text-lg font-bold mb-4 text-white">Platform Distribution</h2>
                    <ResponsiveContainer width="100%" height={250}>
                        <PieChart>
                            <Pie
                                data={data}
                                cx="50%"
                                cy="50%"
                                labelLine={false}
                                outerRadius={80}
                                fill="#8884d8"
                                dataKey="value"
                                nameKey="name"
                                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                            >
                                {data.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                            </Pie>
                            <Tooltip content={<CustomTooltip />}/>
                        </PieChart>
                    </ResponsiveContainer>
                </div>
            );
        }

        // Report 4 & 5: Top Rated & Price vs Rating (Bubble Charts)
        function RatingBubbleChart({ endpoint, title, xKey, yKey, zKey, xName, yName, zName }) {
            const [data, setData] = useState([]);

            useEffect(() => {
                fetch(`http://localhost:5000/api/${endpoint}`)
                    .then(res => res.json())
                    .then(rawData => {
                        const filteredData = rawData.filter(d => d && d[xKey] != null && d[yKey] != null && d[zKey] != null);
                        setData(filteredData);
                    })
                    .catch(error => console.error(`Error fetching ${title}:`, error));
            }, [endpoint]);

            return (
                <div className="chart-container">
                    <h2 className="text-lg font-bold mb-4 text-white">{title}</h2>
                    <ResponsiveContainer width="100%" height={250}>
                        <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#30363d" />
                            <XAxis type="number" dataKey={xKey} name={xName} stroke="#8b949e" />
                            <YAxis type="number" dataKey={yKey} name={yName} stroke="#8b949e" />
                            <ZAxis type="number" dataKey={zKey} name={zName} range={[20, 500]} />
                            <Tooltip cursor={{ strokeDasharray: '3 3' }} content={<CustomTooltip />} />
                            <Scatter name="Games" data={data} fill="#8884d8" />
                        </ScatterChart>
                    </ResponsiveContainer>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [backendStatus, setBackendStatus] = useState('Connecting...');

            useEffect(() => {
                fetch('http://localhost:5000/')
                    .then(res => {
                        if (res.ok) {
                            setBackendStatus('Connected');
                        } else {
                            setBackendStatus('Error');
                        }
                    })
                    .catch(() => setBackendStatus('Failed to Connect'));
            }, []);

            return (
                <div className="min-h-screen p-4 sm:p-6 lg:p-8">
                    <header className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-black tracking-tighter text-white">
                            DIMGAME <span className="text-gray-500">Analytics</span>
                        </h1>
                         <div className="flex items-center space-x-2">
                            <span className={`h-3 w-3 rounded-full ${
                                backendStatus === 'Connected' ? 'bg-green-500' :
                                backendStatus === 'Connecting...' ? 'bg-yellow-500' : 'bg-red-500'
                            }`}></span>
                            <span className="text-sm text-gray-400">{backendStatus === 'Connected' ? 'Backend Connected' : backendStatus}</span>
                        </div>
                    </header>
                    
                    <main className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Main Reports */}
                        <div className="lg:col-span-2">
                            <MostPlayed />
                        </div>
                        <div className="lg:col-span-2">
                            <TrendingGames />
                        </div>

                        {/* Secondary Reports */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 lg:col-span-2">
                            <div className="md:col-span-1">
                                <PlatformBreakdown />
                            </div>
                            <div className="md:col-span-2">
                                 <RatingBubbleChart 
                                    endpoint="top-rated"
                                    title="Top Rated Games (Metacritic vs. User Score)"
                                    xKey="MetacriticScore" yKey="UserScore" zKey="Reviews"
                                    xName="Metacritic" yName="User Score" zName="Total Reviews"
                                />
                            </div>
                        </div>

                         <div className="lg:col-span-2">
                             <RatingBubbleChart
                                endpoint="price-vs-rating"
                                title="Price vs. User Score (Bubble Size = Reviews)"
                                xKey="Price" yKey="UserScore" zKey="Reviews"
                                xName="Price ($)" yName="User Score" zName="Total Reviews"
                            />
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>